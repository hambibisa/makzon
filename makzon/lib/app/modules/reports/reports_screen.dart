import 'package:flutter/material.dart';
import 'package:hive_flutter/hive_flutter.dart';
import 'package:intl/intl.dart';
import '../sales/sale_model.dart';
import '../products/product_model.dart';
import '../clients/client_model.dart'; // سنحتاجه لإجمالي الديون

class ReportsScreen extends StatelessWidget {
  const ReportsScreen({super.key});

    // --- دالة لحساب إجمالي الأرباح ---
      double _calculateTotalProfit(Box<Sale> salesBox, Box<Product> productsBox) {
          double totalProfit = 0.0;
              final productPurchasePrices = {for (var p in productsBox.values) p.id: p.purchasePrice};

                  for (var sale in salesBox.values) {
                        double salePurchaseCost = 0.0;
                              for (int i = 0; i < sale.productIds.length; i++) {
                                      final productId = sale.productIds[i];
                                              final quantity = sale.quantities[i];
                                                      final purchasePrice = productPurchasePrices[productId] ?? 0.0;
                                                              salePurchaseCost += purchasePrice * quantity;
                                                                    }
                                                                          totalProfit += sale.totalAmount - salePurchaseCost;
                                                                              }
                                                                                  return totalProfit;
                                                                                    }

                                                                                      // --- دالة لحساب إجمالي الديون ---
                                                                                        double _calculateTotalDebt(Box<Client> clientsBox) {
                                                                                            return clientsBox.values.fold(0.0, (sum, client) => sum + client.totalDebt);
                                                                                              }

                                                                                                @override
                                                                                                  Widget build(BuildContext context) {
                                                                                                      return Scaffold(
                                                                                                            appBar: AppBar(
                                                                                                                    title: const Text("التقارير"),
                                                                                                                          ),
                                                                                                                                body: ValueListenableBuilder(
                                                                                                                                        valueListenable: Hive.box<Sale>('sales').listenable(),
                                                                                                                                                builder: (context, Box<Sale> salesBox, _) {
                                                                                                                                                          // الاستماع أيضًا لصناديق المنتجات والعملاء للحصول على بيانات دقيقة
                                                                                                                                                                    return ValueListenableBuilder(
                                                                                                                                                                                valueListenable: Hive.box<Product>('products').listenable(),
                                                                                                                                                                                            builder: (context, Box<Product> productsBox, _) {
                                                                                                                                                                                                          return ValueListenableBuilder(
                                                                                                                                                                                                                          valueListenable: Hive.box<Client>('clients').listenable(),
                                                                                                                                                                                                                                          builder: (context, Box<Client> clientsBox, _) {
                                                                                                                                                                                                                                                            final sales = salesBox.values.toList()..sort((a, b) => b.saleDate.compareTo(a.saleDate));
                                                                                                                                                                                                                                                                              final totalSalesValue = sales.fold(0.0, (sum, sale) => sum + sale.totalAmount);
                                                                                                                                                                                                                                                                                                final totalProfit = _calculateTotalProfit(salesBox, productsBox);
                                                                                                                                                                                                                                                                                                                  final totalDebt = _calculateTotalDebt(clientsBox);

                                                                                                                                                                                                                                                                                                                                    return ListView(
                                                                                                                                                                                                                                                                                                                                                        padding: const EdgeInsets.all(16.0),
                                                                                                                                                                                                                                                                                                                                                                            children: [
                                                                                                                                                                                                                                                                                                                                                                                                  _buildStatsGrid(totalSalesValue, totalProfit, totalDebt, sales.length),
                                                                                                                                                                                                                                                                                                                                                                                                                        const Divider(height: 40),
                                                                                                                                                                                                                                                                                                                                                                                                                                              const Text('أحدث العمليات', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const SizedBox(height: 10),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (sales.isEmpty)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const Center(child: Text('لا توجد عمليات بيع مسجلة بعد.'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ...sales.take(10).map((sale) => Card(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              child: ListTile(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              leading: CircleAvatar(child: Icon(sale.isCredit ? Icons.person : Icons.money)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              title: Text('فاتورة بقيمة ${sale.totalAmount.toStringAsFixed(2)} ريال'),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              subtitle: Text(DateFormat('d MMMM yyyy, hh:mm a', 'ar').format(sale.saleDate)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              trailing: sale.isCredit ? const Text('آجل', style: TextStyle(color: Colors.red)) : const Text('نقدي', style: TextStyle(color: Colors.green)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ويدجت مساعد لبناء شبكة الإحصائيات
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Widget _buildStatsGrid(double totalSales, double totalProfit, double totalDebt, int salesCount) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return GridView.count(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    crossAxisCount: 2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          shrinkWrap: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                physics: const NeverScrollableScrollPhysics(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      crossAxisSpacing: 12,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            mainAxisSpacing: 12,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  childAspectRatio: 1.5,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        children: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                _buildStatsCard(title: 'إجمالي المبيعات', value: totalSales.toStringAsFixed(2), icon: Icons.point_of_sale, color: Colors.blue),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        _buildStatsCard(title: 'إجمالي الأرباح', value: totalProfit.toStringAsFixed(2), icon: Icons.trending_up, color: Colors.green),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                _buildStatsCard(title: 'إجمالي الديون', value: totalDebt.toStringAsFixed(2), icon: Icons.credit_card_off, color: Colors.red),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        _buildStatsCard(title: 'عدد الفواتير', value: salesCount.toString(), icon: Icons.receipt, color: Colors.orange),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // ويدجت مساعد لبناء بطاقة الإحصائيات
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Widget _buildStatsCard({required String title, required String value, required IconData icon, required Color color}) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return Card(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  elevation: 2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              child: Padding(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      padding: const EdgeInsets.all(12.0),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              child: Column(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        mainAxisAlignment: MainAxisAlignment.center,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  crossAxisAlignment: CrossAxisAlignment.center,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            children: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Icon(icon, size: 30, color: color),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const SizedBox(height: 8),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Text(title, style: const TextStyle(fontSize: 14, color: Colors.black54), textAlign: TextAlign.center),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const SizedBox(height: 4),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Text('$value ريال', style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold), textAlign: TextAlign.center),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      